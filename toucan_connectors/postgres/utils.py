types = {
    16: "bool",
    17: "bytea",
    18: "char",
    19: "name",
    20: "int8",
    21: "int2",
    22: "int2vector",
    23: "int4",
    24: "regproc",
    25: "text",
    26: "oid",
    27: "tid",
    28: "xid",
    29: "cid",
    30: "oidvector",
    71: "pg_type",
    75: "pg_attribute",
    81: "pg_proc",
    83: "pg_class",
    114: "json",
    142: "xml",
    194: "pg_node_tree",
    3361: "pg_ndistinct",
    3402: "pg_dependencies",
    5017: "pg_mcv_list",
    32: "pg_ddl_command",
    5069: "xid8",
    600: "point",
    601: "lseg",
    602: "path",
    603: "box",
    604: "polygon",
    628: "line",
    700: "float4",
    701: "float8",
    705: "unknown",
    718: "circle",
    790: "money",
    829: "macaddr",
    869: "inet",
    650: "cidr",
    774: "macaddr8",
    1033: "aclitem",
    1042: "bpchar",
    1043: "varchar",
    1082: "date",
    1083: "time",
    1114: "timestamp",
    1184: "timestamptz",
    1186: "interval",
    1266: "timetz",
    1560: "bit",
    1562: "varbit",
    1700: "numeric",
    1790: "refcursor",
    2202: "regprocedure",
    2203: "regoper",
    2204: "regoperator",
    2205: "regclass",
    4191: "regcollation",
    2206: "regtype",
    4096: "regrole",
    4089: "regnamespace",
    2950: "uuid",
    3220: "pg_lsn",
    3614: "tsvector",
    3642: "gtsvector",
    3615: "tsquery",
    3734: "regconfig",
    3769: "regdictionary",
    3802: "jsonb",
    4072: "jsonpath",
    2970: "txid_snapshot",
    5038: "pg_snapshot",
    3904: "int4range",
    3906: "numrange",
    3908: "tsrange",
    3910: "tstzrange",
    3912: "daterange",
    3926: "int8range",
    4451: "int4multirange",
    4532: "nummultirange",
    4533: "tsmultirange",
    4534: "tstzmultirange",
    4535: "datemultirange",
    4536: "int8multirange",
    2249: "record",
    2287: "_record",
    2275: "cstring",
    2276: "any",
    2277: "anyarray",
    2278: "void",
    2279: "trigger",
    3838: "event_trigger",
    2280: "language_handler",
    2281: "internal",
    2283: "anyelement",
    2776: "anynonarray",
    3500: "anyenum",
    3115: "fdw_handler",
    325: "index_am_handler",
    3310: "tsm_handler",
    269: "table_am_handler",
    3831: "anyrange",
    5077: "anycompatible",
    5078: "anycompatiblearray",
    5079: "anycompatiblenonarray",
    5080: "anycompatiblerange",
    4537: "anymultirange",
    4538: "anycompatiblemultirange",
    4600: "pg_brin_bloom_summary",
    4601: "pg_brin_minmax_multi_summary",
    1000: "_bool",
    1001: "_bytea",
    1002: "_char",
    1003: "_name",
    1016: "_int8",
    1005: "_int2",
    1006: "_int2vector",
    1007: "_int4",
    1008: "_regproc",
    1009: "_text",
    1028: "_oid",
    1010: "_tid",
    1011: "_xid",
    1012: "_cid",
    1013: "_oidvector",
    210: "_pg_type",
    270: "_pg_attribute",
    272: "_pg_proc",
    273: "_pg_class",
    199: "_json",
    143: "_xml",
    271: "_xid8",
    1017: "_point",
    1018: "_lseg",
    1019: "_path",
    1020: "_box",
    1027: "_polygon",
    629: "_line",
    1021: "_float4",
    1022: "_float8",
    719: "_circle",
    791: "_money",
    1040: "_macaddr",
    1041: "_inet",
    651: "_cidr",
    775: "_macaddr8",
    1034: "_aclitem",
    1014: "_bpchar",
    1015: "_varchar",
    1182: "_date",
    1183: "_time",
    1115: "_timestamp",
    1185: "_timestamptz",
    1187: "_interval",
    1270: "_timetz",
    1561: "_bit",
    1563: "_varbit",
    1231: "_numeric",
    2201: "_refcursor",
    2207: "_regprocedure",
    2208: "_regoper",
    2209: "_regoperator",
    2210: "_regclass",
    4192: "_regcollation",
    2211: "_regtype",
    4097: "_regrole",
    4090: "_regnamespace",
    2951: "_uuid",
    3221: "_pg_lsn",
    3643: "_tsvector",
    3644: "_gtsvector",
    3645: "_tsquery",
    3735: "_regconfig",
    3770: "_regdictionary",
    3807: "_jsonb",
    4073: "_jsonpath",
    2949: "_txid_snapshot",
    5039: "_pg_snapshot",
    3905: "_int4range",
    3907: "_numrange",
    3909: "_tsrange",
    3911: "_tstzrange",
    3913: "_daterange",
    3927: "_int8range",
    6150: "_int4multirange",
    6151: "_nummultirange",
    6152: "_tsmultirange",
    6153: "_tstzmultirange",
    6155: "_datemultirange",
    6157: "_int8multirange",
    1263: "_cstring",
    12001: "pg_attrdef",
    12000: "_pg_attrdef",
    12003: "pg_constraint",
    12002: "_pg_constraint",
    12005: "pg_inherits",
    12004: "_pg_inherits",
    12007: "pg_index",
    12006: "_pg_index",
    12009: "pg_operator",
    12008: "_pg_operator",
    12011: "pg_opfamily",
    12010: "_pg_opfamily",
    12013: "pg_opclass",
    12012: "_pg_opclass",
    12015: "pg_am",
    12014: "_pg_am",
    12017: "pg_amop",
    12016: "_pg_amop",
    12019: "pg_amproc",
    12018: "_pg_amproc",
    12021: "pg_language",
    12020: "_pg_language",
    12023: "pg_largeobject_metadata",
    12022: "_pg_largeobject_metadata",
    12025: "pg_largeobject",
    12024: "_pg_largeobject",
    12027: "pg_aggregate",
    12026: "_pg_aggregate",
    12029: "pg_statistic",
    12028: "_pg_statistic",
    12031: "pg_statistic_ext",
    12030: "_pg_statistic_ext",
    12033: "pg_statistic_ext_data",
    12032: "_pg_statistic_ext_data",
    12035: "pg_rewrite",
    12034: "_pg_rewrite",
    12037: "pg_trigger",
    12036: "_pg_trigger",
    12039: "pg_event_trigger",
    12038: "_pg_event_trigger",
    12041: "pg_description",
    12040: "_pg_description",
    12043: "pg_cast",
    12042: "_pg_cast",
    12045: "pg_enum",
    12044: "_pg_enum",
    12047: "pg_namespace",
    12046: "_pg_namespace",
    12049: "pg_conversion",
    12048: "_pg_conversion",
    12051: "pg_depend",
    12050: "_pg_depend",
    1248: "pg_database",
    12052: "_pg_database",
    12054: "pg_db_role_setting",
    12053: "_pg_db_role_setting",
    12056: "pg_tablespace",
    12055: "_pg_tablespace",
    2842: "pg_authid",
    12057: "_pg_authid",
    2843: "pg_auth_members",
    12058: "_pg_auth_members",
    12060: "pg_shdepend",
    12059: "_pg_shdepend",
    12062: "pg_shdescription",
    12061: "_pg_shdescription",
    12064: "pg_ts_config",
    12063: "_pg_ts_config",
    12066: "pg_ts_config_map",
    12065: "_pg_ts_config_map",
    12068: "pg_ts_dict",
    12067: "_pg_ts_dict",
    12070: "pg_ts_parser",
    12069: "_pg_ts_parser",
    12072: "pg_ts_template",
    12071: "_pg_ts_template",
    12074: "pg_extension",
    12073: "_pg_extension",
    12076: "pg_foreign_data_wrapper",
    12075: "_pg_foreign_data_wrapper",
    12078: "pg_foreign_server",
    12077: "_pg_foreign_server",
    12080: "pg_user_mapping",
    12079: "_pg_user_mapping",
    12082: "pg_foreign_table",
    12081: "_pg_foreign_table",
    12084: "pg_policy",
    12083: "_pg_policy",
    12086: "pg_replication_origin",
    12085: "_pg_replication_origin",
    12088: "pg_default_acl",
    12087: "_pg_default_acl",
    12090: "pg_init_privs",
    12089: "_pg_init_privs",
    12092: "pg_seclabel",
    12091: "_pg_seclabel",
    4066: "pg_shseclabel",
    12093: "_pg_shseclabel",
    12095: "pg_collation",
    12094: "_pg_collation",
    12097: "pg_partitioned_table",
    12096: "_pg_partitioned_table",
    12099: "pg_range",
    12098: "_pg_range",
    12101: "pg_transform",
    12100: "_pg_transform",
    12103: "pg_sequence",
    12102: "_pg_sequence",
    12105: "pg_publication",
    12104: "_pg_publication",
    12107: "pg_publication_rel",
    12106: "_pg_publication_rel",
    6101: "pg_subscription",
    12108: "_pg_subscription",
    12110: "pg_subscription_rel",
    12109: "_pg_subscription_rel",
    12219: "pg_roles",
    12218: "_pg_roles",
    12224: "pg_shadow",
    12223: "_pg_shadow",
    12229: "pg_group",
    12228: "_pg_group",
    12233: "pg_user",
    12232: "_pg_user",
    12237: "pg_policies",
    12236: "_pg_policies",
    12242: "pg_rules",
    12241: "_pg_rules",
    12247: "pg_views",
    12246: "_pg_views",
    12252: "pg_tables",
    12251: "_pg_tables",
    12257: "pg_matviews",
    12256: "_pg_matviews",
    12262: "pg_indexes",
    12261: "_pg_indexes",
    12267: "pg_sequences",
    12266: "_pg_sequences",
    12272: "pg_stats",
    12271: "_pg_stats",
    12277: "pg_stats_ext",
    12276: "_pg_stats_ext",
    12282: "pg_stats_ext_exprs",
    12281: "_pg_stats_ext_exprs",
    12287: "pg_publication_tables",
    12286: "_pg_publication_tables",
    12292: "pg_locks",
    12291: "_pg_locks",
    12296: "pg_cursors",
    12295: "_pg_cursors",
    12300: "pg_available_extensions",
    12299: "_pg_available_extensions",
    12304: "pg_available_extension_versions",
    12303: "_pg_available_extension_versions",
    12309: "pg_prepared_xacts",
    12308: "_pg_prepared_xacts",
    12314: "pg_prepared_statements",
    12313: "_pg_prepared_statements",
    12318: "pg_seclabels",
    12317: "_pg_seclabels",
    12323: "pg_settings",
    12322: "_pg_settings",
    12329: "pg_file_settings",
    12328: "_pg_file_settings",
    12333: "pg_hba_file_rules",
    12332: "_pg_hba_file_rules",
    12337: "pg_timezone_abbrevs",
    12336: "_pg_timezone_abbrevs",
    12341: "pg_timezone_names",
    12340: "_pg_timezone_names",
    12345: "pg_config",
    12344: "_pg_config",
    12349: "pg_shmem_allocations",
    12348: "_pg_shmem_allocations",
    12353: "pg_backend_memory_contexts",
    12352: "_pg_backend_memory_contexts",
    12357: "pg_stat_all_tables",
    12356: "_pg_stat_all_tables",
    12362: "pg_stat_xact_all_tables",
    12361: "_pg_stat_xact_all_tables",
    12367: "pg_stat_sys_tables",
    12366: "_pg_stat_sys_tables",
    12372: "pg_stat_xact_sys_tables",
    12371: "_pg_stat_xact_sys_tables",
    12376: "pg_stat_user_tables",
    12375: "_pg_stat_user_tables",
    12381: "pg_stat_xact_user_tables",
    12380: "_pg_stat_xact_user_tables",
    12385: "pg_statio_all_tables",
    12384: "_pg_statio_all_tables",
    12390: "pg_statio_sys_tables",
    12389: "_pg_statio_sys_tables",
    12394: "pg_statio_user_tables",
    12393: "_pg_statio_user_tables",
    12398: "pg_stat_all_indexes",
    12397: "_pg_stat_all_indexes",
    12403: "pg_stat_sys_indexes",
    12402: "_pg_stat_sys_indexes",
    12407: "pg_stat_user_indexes",
    12406: "_pg_stat_user_indexes",
    12411: "pg_statio_all_indexes",
    12410: "_pg_statio_all_indexes",
    12416: "pg_statio_sys_indexes",
    12415: "_pg_statio_sys_indexes",
    12420: "pg_statio_user_indexes",
    12419: "_pg_statio_user_indexes",
    12424: "pg_statio_all_sequences",
    12423: "_pg_statio_all_sequences",
    12429: "pg_statio_sys_sequences",
    12428: "_pg_statio_sys_sequences",
    12433: "pg_statio_user_sequences",
    12432: "_pg_statio_user_sequences",
    12437: "pg_stat_activity",
    12436: "_pg_stat_activity",
    12442: "pg_stat_replication",
    12441: "_pg_stat_replication",
    12447: "pg_stat_slru",
    12446: "_pg_stat_slru",
    12451: "pg_stat_wal_receiver",
    12450: "_pg_stat_wal_receiver",
    12455: "pg_stat_subscription",
    12454: "_pg_stat_subscription",
    12460: "pg_stat_ssl",
    12459: "_pg_stat_ssl",
    12464: "pg_stat_gssapi",
    12463: "_pg_stat_gssapi",
    12468: "pg_replication_slots",
    12467: "_pg_replication_slots",
    12473: "pg_stat_replication_slots",
    12472: "_pg_stat_replication_slots",
    12477: "pg_stat_database",
    12476: "_pg_stat_database",
    12482: "pg_stat_database_conflicts",
    12481: "_pg_stat_database_conflicts",
    12486: "pg_stat_user_functions",
    12485: "_pg_stat_user_functions",
    12491: "pg_stat_xact_user_functions",
    12490: "_pg_stat_xact_user_functions",
    12496: "pg_stat_archiver",
    12495: "_pg_stat_archiver",
    12500: "pg_stat_bgwriter",
    12499: "_pg_stat_bgwriter",
    12504: "pg_stat_wal",
    12503: "_pg_stat_wal",
    12508: "pg_stat_progress_analyze",
    12507: "_pg_stat_progress_analyze",
    12513: "pg_stat_progress_vacuum",
    12512: "_pg_stat_progress_vacuum",
    12518: "pg_stat_progress_cluster",
    12517: "_pg_stat_progress_cluster",
    12523: "pg_stat_progress_create_index",
    12522: "_pg_stat_progress_create_index",
    12528: "pg_stat_progress_basebackup",
    12527: "_pg_stat_progress_basebackup",
    12533: "pg_stat_progress_copy",
    12532: "_pg_stat_progress_copy",
    12538: "pg_user_mappings",
    12537: "_pg_user_mappings",
    12543: "pg_replication_origin_status",
    12542: "_pg_replication_origin_status",
    13405: "cardinal_number",
    13404: "_cardinal_number",
    13408: "character_data",
    13407: "_character_data",
    13410: "sql_identifier",
    13409: "_sql_identifier",
    13413: "information_schema_catalog_name",
    13412: "_information_schema_catalog_name",
    13416: "time_stamp",
    13415: "_time_stamp",
    13418: "yes_or_no",
    13417: "_yes_or_no",
    13422: "applicable_roles",
    13421: "_applicable_roles",
    13427: "administrable_role_authorizations",
    13426: "_administrable_role_authorizations",
    13431: "attributes",
    13430: "_attributes",
    13436: "character_sets",
    13435: "_character_sets",
    13441: "check_constraint_routine_usage",
    13440: "_check_constraint_routine_usage",
    13446: "check_constraints",
    13445: "_check_constraints",
    13451: "collations",
    13450: "_collations",
    13456: "collation_character_set_applicability",
    13455: "_collation_character_set_applicability",
    13461: "column_column_usage",
    13460: "_column_column_usage",
    13466: "column_domain_usage",
    13465: "_column_domain_usage",
    13471: "column_privileges",
    13470: "_column_privileges",
    13476: "column_udt_usage",
    13475: "_column_udt_usage",
    13481: "columns",
    13480: "_columns",
    13486: "constraint_column_usage",
    13485: "_constraint_column_usage",
    13491: "constraint_table_usage",
    13490: "_constraint_table_usage",
    13496: "domain_constraints",
    13495: "_domain_constraints",
    13501: "domain_udt_usage",
    13500: "_domain_udt_usage",
    13506: "domains",
    13505: "_domains",
    13511: "enabled_roles",
    13510: "_enabled_roles",
    13515: "key_column_usage",
    13514: "_key_column_usage",
    13520: "parameters",
    13519: "_parameters",
    13525: "referential_constraints",
    13524: "_referential_constraints",
    13530: "role_column_grants",
    13529: "_role_column_grants",
    13534: "routine_column_usage",
    13533: "_routine_column_usage",
    13539: "routine_privileges",
    13538: "_routine_privileges",
    13544: "role_routine_grants",
    13543: "_role_routine_grants",
    13548: "routine_routine_usage",
    13547: "_routine_routine_usage",
    13553: "routine_sequence_usage",
    13552: "_routine_sequence_usage",
    13558: "routine_table_usage",
    13557: "_routine_table_usage",
    13563: "routines",
    13562: "_routines",
    13568: "schemata",
    13567: "_schemata",
    13572: "sequences",
    13571: "_sequences",
    13577: "sql_features",
    13576: "_sql_features",
    13582: "sql_implementation_info",
    13581: "_sql_implementation_info",
    13587: "sql_parts",
    13586: "_sql_parts",
    13592: "sql_sizing",
    13591: "_sql_sizing",
    13597: "table_constraints",
    13596: "_table_constraints",
    13602: "table_privileges",
    13601: "_table_privileges",
    13607: "role_table_grants",
    13606: "_role_table_grants",
    13611: "tables",
    13610: "_tables",
    13616: "transforms",
    13615: "_transforms",
    13621: "triggered_update_columns",
    13620: "_triggered_update_columns",
    13626: "triggers",
    13625: "_triggers",
    13631: "udt_privileges",
    13630: "_udt_privileges",
    13636: "role_udt_grants",
    13635: "_role_udt_grants",
    13640: "usage_privileges",
    13639: "_usage_privileges",
    13645: "role_usage_grants",
    13644: "_role_usage_grants",
    13649: "user_defined_types",
    13648: "_user_defined_types",
    13654: "view_column_usage",
    13653: "_view_column_usage",
    13659: "view_routine_usage",
    13658: "_view_routine_usage",
    13664: "view_table_usage",
    13663: "_view_table_usage",
    13669: "views",
    13668: "_views",
    13674: "data_type_privileges",
    13673: "_data_type_privileges",
    13679: "element_types",
    13678: "_element_types",
    13684: "_pg_foreign_table_columns",
    13683: "__pg_foreign_table_columns",
    13689: "column_options",
    13688: "_column_options",
    13693: "_pg_foreign_data_wrappers",
    13692: "__pg_foreign_data_wrappers",
    13697: "foreign_data_wrapper_options",
    13696: "_foreign_data_wrapper_options",
    13701: "foreign_data_wrappers",
    13700: "_foreign_data_wrappers",
    13705: "_pg_foreign_servers",
    13704: "__pg_foreign_servers",
    13710: "foreign_server_options",
    13709: "_foreign_server_options",
    13714: "foreign_servers",
    13713: "_foreign_servers",
    13718: "_pg_foreign_tables",
    13717: "__pg_foreign_tables",
    13723: "foreign_table_options",
    13722: "_foreign_table_options",
    13727: "foreign_tables",
    13726: "_foreign_tables",
    13731: "_pg_user_mappings",
    13730: "__pg_user_mappings",
    13736: "user_mapping_options",
    13735: "_user_mapping_options",
    13741: "user_mappings",
    13740: "_user_mappings",
}


def _build_materialized_views_info_extraction_query(db_name: str | None) -> str:
    # Here, we need to query pg_catalog because materialized views are not a standard SQL feature
    # and are thus not available in information_schema.
    # The WHERE condition filters to retrieve materialized views only and excludes system columns
    # (see https://www.postgresql.org/docs/current/catalog-pg-attribute.html).
    # The CASE statement is to format postgres types to sql types as found in information_schema
    database_name = f"'{db_name}'" if db_name else "NULL"
    return f"""
    SELECT {database_name} AS "database",
    ns.nspname AS "schema",
    'view' AS "table_type",
    cls.relname AS table_name,
    JSON_AGG(
        JSON_BUILD_OBJECT(
            'name', attr.attname,
            'type', CASE
                WHEN tp.typname = 'int2' THEN 'smallint'
                WHEN tp.typname = 'bpchar' THEN 'character'
                WHEN tp.typname IN ('int4', 'int8') THEN 'integer'
                WHEN tp.typname IN ('float2', 'float4', 'float8') THEN 'real'
            ELSE tp.typname
            END
        )
    ) AS columns
    FROM pg_catalog.pg_attribute AS attr
    JOIN pg_catalog.pg_class AS cls ON cls.oid = attr.attrelid
    JOIN pg_catalog.pg_namespace AS ns ON ns.oid = cls.relnamespace
    JOIN pg_catalog.pg_type AS tp ON tp.oid = attr.atttypid
    WHERE cls.relname in (SELECT matviewname FROM pg_matviews) AND attr.attnum >= 0
    GROUP BY schema, database, table_name, table_type
    """


def _build_regular_tables_model_extraction_query() -> str:
    return """SELECT t.table_catalog AS database,
    t.table_schema AS schema,
    CASE WHEN t.table_type = 'BASE TABLE' THEN 'table' ELSE lower(t.table_type) END AS type,
    t.table_name AS name,
    JSON_AGG(JSON_BUILD_OBJECT('name', c.column_name, 'type', c.data_type)) AS columns
    FROM
        information_schema.tables t
    INNER JOIN information_schema.columns c ON
        t.table_name = c.table_name AND t.table_schema = c.table_schema
    WHERE t.table_type IN ('BASE TABLE', 'VIEW')
    AND t.table_schema NOT IN  ('pg_catalog', 'information_schema', 'pg_internal')
    GROUP BY t.table_schema, t.table_catalog, t.table_name, t.table_type
    """


def build_database_model_extraction_query(db_name: str | None, include_materialized_views: bool) -> str:
    return (
        f"""{_build_regular_tables_model_extraction_query()}
        UNION ALL
        {_build_materialized_views_info_extraction_query(db_name)};
        """
        if include_materialized_views
        else _build_regular_tables_model_extraction_query() + ";"
    )
