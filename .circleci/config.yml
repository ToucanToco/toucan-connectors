version: 2

jobs:
  main:
    docker:
      - image: circleci/python:3.6
    steps:
      - checkout
      # prepare
      - run: sudo apt-get update
      - run: sudo apt-get install freetds-dev libsasl2-dev
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
      - setup_remote_docker
      - run: docker-compose -f tests/docker-compose.yml pull
      - run: sudo pip install --upgrade pip setuptools
      # oracle dependencies
      - run: sudo apt-get install libaio1
      - run: sudo mkdir -p /opt/oracle
      - run: curl -c /tmp/cookie -L -o /tmp/oracle_client_lib.zip "https://drive.google.com/uc?export=download&id=1prPWRnaVMxDsIiSGJqz0TkFT7wXrCgaO"
      - run: sudo unzip /tmp/oracle_client_lib.zip -d /opt/oracle
      - run: sudo sh -c "echo /opt/oracle/instantclient_12_2 > /etc/ld.so.conf.d/oracle-instantclient.conf"
      - run: sudo ldconfig
      # test
      - run: sudo pip install -r requirements-testing.txt
      - run: sudo pip install .[all]
      - run: sudo pip install codecov
      - run: flake8 toucan_connectors tests
      - run: pytest tests
      - run: codecov --token=3e56598d-bfe8-4741-a973-f4b70bd2c280


workflows:
  version: 2
  build:
    jobs:
      - main
