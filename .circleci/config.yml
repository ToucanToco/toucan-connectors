version: 2

jobs:
  build:
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run:
          name: Install system dependencies
          command: |
            sudo apt-get update
            sudo apt-get install freetds-dev libsasl2-dev libpq-dev
      - run:
          name: Install oracle dependencies
          command: sudo bash toucan_connectors/install_scripts/oracle.sh
      - run:
          name: Install databricks dependencies
          command: sudo bash toucan_connectors/install_scripts/databricks.sh
      - run:
          name: Install azure_mssql dependencies
          command: sudo bash toucan_connectors/install_scripts/azure_mssql.sh
      - run:
          name: Install python 3.6 and setup virtualenv
          command: |
            pyenv install 3.6.8
            /opt/circleci/.pyenv/versions/3.6.8/bin/python3 -m venv ./venv
            echo 'export PATH=/home/circleci/project/venv/bin:$PATH' >> $BASH_ENV
      - run:
          name: Install python librairies
          command: |
            make install
            pip3 install codecov
      - run:
          name: Pulling all docker images
          command: docker-compose -f tests/docker-compose.yml pull
      - run: make all
      - run: codecov --token=3e56598d-bfe8-4741-a973-f4b70bd2c280
